# Enhanced WebPlatform Digest Tool - v1.1 Performance Optimization Plan

## 背景
- 基于 `project_docs/tech_docs/1.0-architecture-review-webplatform-digest.md` 的评审结果，当前实现存在并发调度粗糙、I/O 阻塞、缓存策略缺失等性能瓶颈。
- 目标是在不牺牲功能正确性的前提下，缩短单次 digest 生成时长、降低资源占用，并为后续扩展提供可观测与治理能力。

## 目标
- 将单区域 digest 生成的 P95 时长降低 30%。
- 将同一版本全量生成的峰值内存占用下降 20%。
- 建立基础性能指标采集与告警能力，覆盖 LLM 调用、文件 I/O、并发任务执行。
- 在 MCP 层实现工具实例复用与互斥控制，避免跨工具抢占资源。

## 里程碑
1. **M1 - Telemetry & Baseline**: 完成性能基线采集与指标埋点。
2. **M2 - Concurrency Governance**: 引入统一的并发与速率控制，优化运行时调度。
3. **M3 - Pipeline Efficiency**: 精简 pipeline 结构，减少重复 I/O 与内存占用。
4. **M4 - MCP Runtime Coordination**: 在 FastMCP 层落实实例生命周期与共享资源治理。

## 任务清单

### M1 - Telemetry & Baseline
- **T1.1** 建立性能基线：对当前版本的 per-area 时间、LLM 延迟、内存占用进行 profiling，并输出基线报告。  
  `参考: 1.0-architecture-review-webplatform-digest.md §3`
- **T1.2** 在 `_generate_per_area_digests` 及 `_safe_sample_with_retry` 内添加结构化耗时日志与 Prometheus 兼容指标。  
  `参考: src/mcp_tools/enhanced_webplatform_digest.py:1068-1250`
- **T1.3** 引入错误/重试计数指标，覆盖 LLM 重试、翻译 fallback、文件写入失败等场景。  
  `参考: 1.0-architecture-review-webplatform-digest.md §4`

### M2 - Concurrency Governance
- **T2.1** 抽象并发控制器，集中管理 `asyncio.Semaphore`、重试与 backoff 参数，避免散落常量。  
  `参考: src/mcp_tools/enhanced_webplatform_digest.py:1084-1108`
- **T2.2** 在进度写入 `_update_progress` 中加入节流或后台写入，防止频繁 I/O 阻塞事件循环。  
  `参考: src/mcp_tools/enhanced_webplatform_digest.py:1006-1050`
- **T2.3** 为 LLM 调用引入速率限制与熔断策略，发生连续失败时暂停后续任务。  
  `参考: 1.0-architecture-review-webplatform-digest.md §3·潜在风险`

### M3 - Pipeline Efficiency
- **T3.1** 将 `process_area` 提取为独立可复用的方法/对象，精简闭包捕获，减少内存压力。  
  `参考: src/mcp_tools/enhanced_webplatform_digest.py:1095-1250`
- **T3.2** 拆分 YAML 加载与缓存逻辑，避免重复读取同一区域数据；引入缓存命中率指标。  
  `参考: src/mcp_tools/enhanced_webplatform_digest.py:205-360`
- **T3.3** 整理模型偏好 `_model_preferences` 的作用域，防止实例级状态泄漏导致额外的 LLM 请求。  
  `参考: src/mcp_tools/enhanced_webplatform_digest.py:76-151`
- **T3.4** 统一生成英文/中文 digest 的共通逻辑，减少重复文件写入，大幅降低 I/O。  
  `参考: src/mcp_tools/enhanced_webplatform_digest.py:177-257`

### M4 - MCP Runtime Coordination
- **T4.1** 在 `fast_mcp_server.py` 中实现工具实例缓存与依赖注入容器，确保 FocusAreaManager、配置等可复用。  
  `参考: fast_mcp_server.py:148-188`
- **T4.2** 调整 `register_dynamic_resources()` 为延迟或增量注册，降低启动时扫描成本。  
  `参考: fast_mcp_server.py:283-310`
- **T4.3** 引入跨工具互斥/队列机制，协调 `webplatform_digest` 与 `generate_github_pages` 的文件写入。  
  `参考: fast_mcp_server.py:217-269`
- **T4.4** 在 MCP 层汇总性能指标，输出统一的监控/告警入口。  
  `参考: 1.0-architecture-review-webplatform-digest.md §11`

## 风险与依赖
- 需要评估引入新指标对日志量与存储的影响，避免额外的运维压力。
- MCP 运行时的改动可能影响现有工具调用方式，应提前与下游使用方沟通变更窗口。
- LLM 速率限制策略需与平台配额对齐，避免误触发 API 限制。

## 验收标准
- 指标平台可观测到 per-area 时长、LLM 调用次数、进度写入频率等核心数据。
- 在测试环境验证新版 pipeline 后，全量生成耗时与内存占用达到目标降幅。
- MCP 工具能够在高并发请求下保持稳定，未出现文件竞态或资源冲突。
