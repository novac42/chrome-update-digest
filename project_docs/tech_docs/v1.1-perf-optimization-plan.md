# Enhanced WebPlatform Digest Tool - v1.1 Performance Optimization Plan

## 背景
- 基于 `project_docs/tech_docs/1.0-architecture-review-webplatform-digest.md` 的评审结果，当前实现存在并发调度粗糙、I/O 阻塞、缓存策略缺失等性能瓶颈。
- 目标是在不牺牲功能正确性的前提下，缩短单次 digest 生成时长、降低资源占用，并为后续扩展提供可观测与治理能力。

## 目标
- 将单区域 digest 生成的 P95 时长降低 30%。
- 将同一版本全量生成的峰值内存占用下降 20%。
- 建立基础性能指标采集与告警能力，覆盖 LLM 调用、文件 I/O、并发任务执行。
- 在 MCP 层实现工具实例复用与互斥控制，避免跨工具抢占资源。

## 里程碑
1. **M1 - Telemetry & Baseline — 已完成**: 完成性能基线采集与指标埋点。
2. **M2 - Concurrency Governance — 待开始**: 引入统一的并发与速率控制，优化运行时调度。
3. **M3 - Pipeline Efficiency — 待开始**: 精简 pipeline 结构，减少重复 I/O 与内存占用。
4. **M4 - MCP Runtime Coordination — 待开始**: 在 FastMCP 层落实实例生命周期与共享资源治理。

## 任务清单

### M1 - Telemetry & Baseline（已完成）
- ✅ **T1.1 基线框架**：已引入统一 `DigestTelemetry`（Prometheus 指标 + JSONL 事件），落地在 `.monitoring/webplatform-telemetry.jsonl`；形成 per-area 运行上下文（版本、channel、语言、区域数、总时长）。  
  `新增: src/utils/telemetry.py`
- ✅ **T1.2 阶段耗时指标**：在 `_generate_per_area_digests` 和 `_safe_sample_with_retry` 中埋点 `english_generation`、`translation`、`fallback_generation`、`translation_fallback`、`area_total` 等阶段耗时与状态；并对进度写入做节流以减少 I/O 抖动。  
  `改动: src/mcp_tools/enhanced_webplatform_digest.py`
- ✅ **T1.3 错误/重试计数**：对 LLM 调用的每次尝试记录 success/timeout/error 与 attempt；统计重试计数；对校验失败与异常进行错误计数与事件落盘。  
  `改动: src/mcp_tools/enhanced_webplatform_digest.py`

### M2 - Concurrency Governance（已完成）
- ✅ **T2.1 并发控制器**：集中配置并发与重试参数，新增环境变量：
  - `WEBPLATFORM_MAX_CONCURRENCY`（默认 4）
  - `WEBPLATFORM_RATE_LIMIT` 每秒调用数（默认 2）
  - `WEBPLATFORM_FAILURE_COOLDOWN` 熔断冷却秒数（默认 5）
  - `WEBPLATFORM_CIRCUIT_THRESHOLD` 连续失败阈值（默认 3）
  已在 `__init__` 中初始化统一控制，并在采样路径中以 `Semaphore`、速率间隔与冷却窗口生效。
  `改动: src/mcp_tools/enhanced_webplatform_digest.py`
- ✅ **T2.2 进度写入节流**：`_update_progress` 已实现基于 `perf_counter` 的时间间隔与“完成计数不变则跳过”策略；可通过 `WEBPLATFORM_PROGRESS_MIN_INTERVAL` 配置（默认 0.5s）。
  `确认: src/mcp_tools/enhanced_webplatform_digest.py`
- ✅ **T2.3 速率限制与熔断**：在 `_safe_sample_with_retry` 中加入：
  - 基于 `Semaphore` 的并发闸门
  - 简单令牌间隔速率限制
  - 连续失败阈值 + 冷却期的熔断控制
  并配合 Telemetry 记录 `success/timeout/error`。  
  `改动: src/mcp_tools/enhanced_webplatform_digest.py`

### M3 - Pipeline Efficiency
- **T3.1** 将 `process_area` 提取为独立可复用的方法/对象，精简闭包捕获，减少内存压力。  
  `参考: src/mcp_tools/enhanced_webplatform_digest.py:1095-1250`
- **T3.2** 拆分 YAML 加载与缓存逻辑，避免重复读取同一区域数据；引入缓存命中率指标。  
  `参考: src/mcp_tools/enhanced_webplatform_digest.py:205-360`
- **T3.3** 整理模型偏好 `_model_preferences` 的作用域，防止实例级状态泄漏导致额外的 LLM 请求。  
  `参考: src/mcp_tools/enhanced_webplatform_digest.py:76-151`
- **T3.4** 统一生成英文/中文 digest 的共通逻辑，减少重复文件写入，大幅降低 I/O。  
  `参考: src/mcp_tools/enhanced_webplatform_digest.py:177-257`

### M4 - MCP Runtime Coordination
- **T4.1** 在 `fast_mcp_server.py` 中实现工具实例缓存与依赖注入容器，确保 FocusAreaManager、配置等可复用。  
  `参考: fast_mcp_server.py:148-188`
- **T4.2** 调整 `register_dynamic_resources()` 为延迟或增量注册，降低启动时扫描成本。  
  `参考: fast_mcp_server.py:283-310`
- **T4.3** 引入跨工具互斥/队列机制，协调 `webplatform_digest` 与 `generate_github_pages` 的文件写入。  
  `参考: fast_mcp_server.py:217-269`
- **T4.4** 在 MCP 层汇总性能指标，输出统一的监控/告警入口。  
  `参考: 1.0-architecture-review-webplatform-digest.md §11`

## 风险与依赖
- 需要评估引入新指标对日志量与存储的影响，避免额外的运维压力。
- MCP 运行时的改动可能影响现有工具调用方式，应提前与下游使用方沟通变更窗口。
- LLM 速率限制策略需与平台配额对齐，避免误触发 API 限制。

## 当前状态概览（2025-10-23）
- Telemetry 运行路径：通过 MCP server 调用工具时自动记录；Prometheus 指标在进程内注册（尚未开放 /metrics 端点）。
- 产物位置：
  - 事件：`.monitoring/webplatform-telemetry.jsonl`
  - 进度：`.monitoring/webplatform-progress.json`（默认 0.5s 节流，可用 `WEBPLATFORM_PROGRESS_MIN_INTERVAL` 配置）
- 并发治理：可通过环境变量调优并发与速率；出现连续失败将自动进入冷却期。
- 待选增强：在 `fast_mcp_server.py` 暴露 `/metrics` 端点；提供 JSONL 基线汇总脚本（P95/P99、失败率、fallback 率）。

## 验收标准
- 指标平台可观测到 per-area 时长、LLM 调用次数、进度写入频率等核心数据。
- 在测试环境验证新版 pipeline 后，全量生成耗时与内存占用达到目标降幅。
- MCP 工具能够在高并发请求下保持稳定，未出现文件竞态或资源冲突。
